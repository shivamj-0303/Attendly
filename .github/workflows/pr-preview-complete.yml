name: PR Preview - Complete Deployment

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  # Build Backend
  build-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build Backend
        run: |
          cd backend
          mvn clean package -DskipTests

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 7

  # Build Mobile APK
  build-mobile-apk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: mobile-app
        run: npm ci

      - name: Build Preview APK
        working-directory: mobile-app
        run: |
          echo "ðŸ”§ Building APK with API URL: ${{ secrets.VITE_API_BASE_URL }}"
          
          # Map VITE_API_BASE_URL to EXPO_PUBLIC_API_URL (Metro bundler requirement)
          export EXPO_PUBLIC_API_URL="${{ secrets.VITE_API_BASE_URL }}"
          
          # Build the APK
          echo "ðŸš€ Starting EAS build..."
          eas build --platform android --profile preview --local
          
          echo "âœ… Build complete!"
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Find APK and Upload Info
        id: apk
        run: |
          cd mobile-app
          APK_FILE=$(ls -t build-*.apk | head -1)
          echo "apk-name=$APK_FILE" >> $GITHUB_OUTPUT
          echo "APK built: $APK_FILE"
          ls -lh "$APK_FILE"

  # Deploy Unified App Preview (Landing Page + Admin Panel)
  deploy-unified-preview:
    runs-on: ubuntu-latest
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy Unified App to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./landing-page
          scope: ${{ secrets.VERCEL_ORG_ID }}
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

  # Create PR Comment with all links
  comment-pr:
    runs-on: ubuntu-latest
    needs: [build-backend, build-mobile-apk, deploy-unified-preview]
    if: always()
    steps:
      - name: Create/Update PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const branchName = context.payload.pull_request.head.ref;
            const commitSha = context.payload.pull_request.head.sha.substring(0, 7);
            
            const appUrl = '${{ needs.deploy-unified-preview.outputs.preview-url }}';
            
            const backendStatus = '${{ needs.build-backend.result }}';
            const mobileStatus = '${{ needs.build-mobile-apk.result }}';
            const appStatus = '${{ needs.deploy-unified-preview.result }}';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              return 'â³';
            };
            
            const comment = `## ðŸš€ PR Preview Deployment
            
            ### ðŸ“¦ Build Status
            
            | Component | Status | Details |
            |-----------|--------|---------|
            | Backend (JAR) | ${statusIcon(backendStatus)} | Spring Boot application |
            | Mobile App (APK) | ${statusIcon(mobileStatus)} | React Native with Expo |
            | Unified Web App | ${statusIcon(appStatus)} | Landing Page + Admin Panel |
            
            ### ðŸŒ Preview URLs
            
            | Service | URL | Description |
            |---------|-----|-------------|
            | **ðŸ  Landing Page** | [Open Preview](${appUrl}) | Home page with APK download |
            | **ðŸ‘¤ Admin Panel** | [Open Admin](${appUrl}/admin) | Admin login & dashboard |
            | **ðŸ”§ Backend API** | Check Render Dashboard | Backend services |
            
            ### ðŸ“± Mobile App Testing
            
            The mobile APK is being built with EAS Build. Once complete:
            
            1. **Download APK**: Check [Expo Dashboard](https://expo.dev/accounts/[your-account]/projects/attendly/builds) for download link
            2. **Test on Device**: Install APK on Android device
            3. **Or Use Expo Go**: 
               \`\`\`bash
               cd mobile-app
               npm start
               # Scan QR code with Expo Go app
               \`\`\`
            
            ### âœ… Testing Checklist
            
            - [ ] Visit landing page and check APK download button
            - [ ] Click "Admin Panel" button in header
            - [ ] Login to admin panel with test credentials
            - [ ] Download and install APK on Android device
            - [ ] Test mobile app login/signup
            - [ ] Verify all features work with preview backend
            
            ### ðŸ” Deployment Details
            
            - **Branch**: \`${branchName}\`
            - **Commit**: \`${commitSha}\`
            - **Deployed**: ${new Date().toISOString()}
            - **Environment**: Preview
            
            ### ðŸ“ How to Test
            
            1. **Landing Page**
               - Visit the landing page preview URL
               - Check all sections load correctly
               - Verify APK download button (APK may need manual upload)
               - Click "Admin Panel" button to navigate
            
            2. **Admin Panel**
               - Click Admin Panel button or use direct link
               - Test login with credentials
               - Verify dashboard loads
               - Check all admin features
            
            3. **Mobile App**
               - Once APK is ready, download from Expo dashboard
               - Install on Android device
               - Test login/signup
               - Verify API connectivity
            
            ### ðŸ”§ If Issues Found
            
            1. Check logs in GitHub Actions
            2. Verify environment variables are set
            3. Test API endpoints manually
            4. Check browser console for errors
            
            ---
            
            ðŸ’¡ **Tip**: The landing page has a link to the admin panel in the header. All services are connected!
            
            *Preview deployments will be automatically cleaned up when PR is merged or closed.*`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Preview Deployment')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
