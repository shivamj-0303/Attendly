name: Production Deployment

on:
  push:
    branches: [main]

env:
  NODE_VERSION: '20'
  JAVA_VERSION: '17'

jobs:
  # Build and Deploy Backend
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build Backend
        run: |
          cd backend
          mvn clean package -DskipTests

      - name: Deploy to Render
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

  # Build and Upload Mobile APK
  build-and-upload-apk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: mobile-app/package-lock.json

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: |
          cd mobile-app
          npm ci

      - name: Build Production APK with Local Build
        run: |
          cd mobile-app
          # Build APK locally with the working command
          VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }} bash build-apk.sh
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Find and Copy APK
        run: |
          cd mobile-app
          # Find the latest built APK
          APK_FILE=$(ls -t build-*.apk | head -1)
          echo "Found APK: $APK_FILE"
          
          # Create downloads directory
          mkdir -p ../landing-page/public/downloads/
          
          # Copy and rename APK
          cp "$APK_FILE" ../landing-page/public/downloads/attendly.apk
          
          # Verify
          ls -lh ../landing-page/public/downloads/attendly.apk

      - name: Commit APK to Repository
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add landing-page/public/downloads/attendly.apk
          git diff --cached --quiet || git commit -m "chore: update production APK [skip ci]"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APK as Artifact (Backup)
        uses: actions/upload-artifact@v4
        with:
          name: production-apk
          path: landing-page/public/downloads/attendly.apk
          retention-days: 90

  # Deploy Unified App (Landing Page + Admin Panel) with APK
  deploy-unified-app:
    runs-on: ubuntu-latest
    needs: [build-and-upload-apk]
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
      
      # Pull the latest changes (including the committed APK)
      - name: Pull Latest Changes
        run: |
          git pull origin main
      
      - name: Verify APK Exists
        run: |
          ls -lh landing-page/public/downloads/attendly.apk
          echo "APK file size: $(du -h landing-page/public/downloads/attendly.apk | cut -f1)"

      - name: Deploy Unified App to Vercel Production
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./landing-page
          scope: ${{ secrets.VERCEL_ORG_ID }}
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

  # Create Deployment Summary
  deployment-summary:
    runs-on: ubuntu-latest
    needs: [deploy-backend, build-and-upload-apk, deploy-unified-app]
    if: always()
    steps:
      - name: Create Deployment Summary
        uses: actions/github-script@v7
        with:
          script: |
            const backendStatus = '${{ needs.deploy-backend.result }}';
            const mobileStatus = '${{ needs.build-and-upload-apk.result }}';
            const appStatus = '${{ needs.deploy-unified-app.result }}';
            const appUrl = '${{ needs.deploy-unified-app.outputs.deployment-url }}';
            const apkDownloadUrl = 'https://github.com/shivamj-0303/Attendly/raw/main/landing-page/public/downloads/attendly.apk';
            
            const statusIcon = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'skipped') return 'â­ï¸';
              return 'â³';
            };
            
            const summary = `# ðŸš€ Production Deployment Complete
            
            ## Deployment Status
            
            | Component | Status | URL |
            |-----------|--------|-----|
            | Backend API | ${statusIcon(backendStatus)} | ${{ secrets.VITE_API_BASE_URL }} |
            | Mobile APK | ${statusIcon(mobileStatus)} | [Download APK](${apkDownloadUrl}) |
            | Unified Web App | ${statusIcon(appStatus)} | ${appUrl} |
            
            ## ðŸ“± Mobile App
            
            - **APK Built**: ${statusIcon(mobileStatus)}
            - **Direct Download**: [attendly.apk](${apkDownloadUrl})
            - **Committed to Repo**: landing-page/public/downloads/attendly.apk
            - **Available on Landing Page**: ${appUrl}
            
            ## ðŸŒ Live URLs
            
            1. **Landing Page**: ${appUrl} (Users can download APK here)
            2. **Admin Panel**: ${appUrl}/admin (Admin login and dashboard)
            3. **Backend API**: ${{ secrets.VITE_API_BASE_URL }}
            4. **APK Download**: ${apkDownloadUrl}
            
            ## âœ… Post-Deployment Checks
            
            - [ ] Visit landing page and verify APK download works
            - [ ] Click "Admin Panel" button and test login
            - [ ] Download and test mobile APK on Android device
            - [ ] Verify all services are connected
            - [ ] Test mobile app login with backend
            
            ---
            
            *Deployed at ${new Date().toISOString()}*
            *Commit: ${context.sha.substring(0, 7)}*
            *APK built with VITE_API_BASE_URL from GitHub secrets*
            `;
            
            // Create issue comment for main branch push
            const commits = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 1
            });
            
            if (commits.data.length > 0) {
              const commit = commits.data[0];
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: summary
              });
            }
            
            // Also output to workflow summary
            await core.summary
              .addRaw(summary)
              .write();
